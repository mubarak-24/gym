{% extends "base.html" %}
{% block title %}My Routines{% endblock %}

{% block content %}
<style>
  .hidden { display:none }
  .row { display:flex; gap:12px; flex-wrap:wrap }
  .stack { display:flex; flex-direction:column; gap:10px }
  .grid { display:grid; grid-template-columns: 1fr auto; gap:10px }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px }
  .pill { text-decoration:none; padding:6px 10px; border-radius:999px; border:1px solid #e5e5e5 }
  .card { border:1px solid #eaeaea; border-radius:12px; padding:12px; background:#fff }
  .small { font-size:.9rem; opacity:.8 }
  label { display:block; margin:6px 0 4px }
  input, select, button, textarea { padding:9px 11px; border-radius:10px; border:1px solid #ddd }
  button { cursor:pointer }
  .danger { color:crimson }
  .good { color:#0a6c3c }
  .list { display:grid; gap:10px; margin-top:10px }
  .title { font-weight:700; font-size:1.1rem }
  .muted { opacity:.7 }
  .ex-row { display:grid; grid-template-columns: 1fr 90px 40px; gap:8px; align-items:center }
  .ex-row input[type="number"] { width:100% }
</style>

<div class="topbar">
  <h1>My Routines</h1>
  <div class="row">
    <a href="{{ url_for('workouts') }}" class="pill">← Back to Workouts</a>
    <a href="{{ url_for('home') }}" class="pill">Dashboard</a>
  </div>
</div>

<div id="msg" class="small" style="min-height:20px;margin-bottom:8px;"></div>

<div class="card">
  <div class="stack">
    <div>
      <div class="title">Your sessions (max 6)</div>
      <div class="small muted">Saved on this device only (localStorage: <code>gl_my_programs</code>).</div>
    </div>

    <div id="limitNote" class="small"></div>

    <div id="daysList" class="list"></div>

    <div>
      <button id="addDayBtn" type="button">+ Add a new session</button>
      <button id="resetAllBtn" type="button" style="margin-left:8px">Reset all (clear)</button>
    </div>
  </div>
</div>

<!-- Editor -->
<div id="editorWrap" class="card hidden" style="margin-top:12px">
  <div class="stack">
    <div class="title" id="editorTitle">New session</div>

    <div class="row">
      <div style="flex:1; min-width:220px">
        <label for="dayTitle">Session title</label>
        <input id="dayTitle" placeholder="e.g., Upper A, Lower B, Push, Full Body">
      </div>
      <div>
        <label for="dayOrder">Order</label>
        <input id="dayOrder" type="number" min="0" step="1" value="0">
      </div>
    </div>

    <div class="stack">
      <div class="row" style="align-items:center; justify-content:space-between">
        <div class="title" style="font-size:1rem">Exercises</div>
        <button id="addExBtn" type="button">+ Add exercise</button>
      </div>

      <div id="exList" class="stack"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="saveDayBtn" type="button">Save session</button>
      <button id="cancelEditBtn" type="button">Cancel</button>
      <span class="small muted" id="editorHint"></span>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------------- config / storage ----------------
  const STORAGE_KEY = 'gl_my_programs';
  const MAX_DAYS = 6;
  const PROGRAM_ID = 'local-1';

  const el = id => document.getElementById(id);
  const msg = (t, kind="info") => {
    const m = el("msg"); if(!m) return;
    m.classList.remove("danger","good");
    if(kind==="error") m.classList.add("danger");
    if(kind==="good") m.classList.add("good");
    m.textContent = t || "";
  };
  const slug = (s) => (s||"").toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'').slice(0,16) || "day";
  const uid = () => Math.random().toString(36).slice(2,8);

  function loadPrograms(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch (_) { return []; }
  }
  function savePrograms(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }
  function getOrCreateProgram(){
    let list = loadPrograms();
    let prog = list.find(p => p.id === PROGRAM_ID);
    if(!prog){
      prog = { id: PROGRAM_ID, name: "My Routines", days: [] };
      list.push(prog);
      savePrograms(list);
    }
    return { list, prog };
  }

  // ---------------- state ----------------
  let currentEdit = null; // { id, index } or null

  // ---------------- render list ----------------
  function render(){
    const { prog } = getOrCreateProgram();
    const days = [...(prog.days || [])].sort((a,b)=> (a.order_index||0)-(b.order_index||0));
    const box = el('daysList');
    box.innerHTML = "";

    el('limitNote').textContent = `${days.length} / ${MAX_DAYS} sessions`;
    el('addDayBtn').disabled = days.length >= MAX_DAYS;

    if(days.length === 0){
      const div = document.createElement('div');
      div.className = 'small muted';
      div.textContent = "No sessions yet. Click “Add a new session”.";
      box.appendChild(div);
      return;
    }

    days.forEach(d=>{
      const div = document.createElement('div');
      div.className = 'card';
      const exCount = (d.exercises||[]).length;
      div.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center">
          <div>
            <div class="title">${d.title || d.code || 'Session'}</div>
            <div class="small muted">${exCount} exercise${exCount===1?'':'s'} • code: <code>${d.code}</code> • order: ${d.order_index||0}</div>
          </div>
          <div class="row">
            <button data-act="edit" data-id="${d.id}">Edit</button>
            <button data-act="delete" data-id="${d.id}" style="margin-left:6px">Delete</button>
          </div>
        </div>
      `;
      box.appendChild(div);
    });
  }

  // ---------------- edit form helpers ----------------
  function openEditor(day){
    currentEdit = day ? { id: day.id } : null;
    el('editorTitle').textContent = day ? `Edit: ${day.title||day.code}` : "New session";
    el('dayTitle').value = day?.title || "";
    el('dayOrder').value = day?.order_index ?? 0;

    const exList = el('exList');
    exList.innerHTML = "";
    (day?.exercises || [{exercise:"Bench press", sets:2}]).forEach(addExerciseRow);

    el('editorHint').textContent = "Tip: keep sets small (1–3) and progress weekly.";
    el('editorWrap').classList.remove('hidden');
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }

  function addExerciseRow(ex){
    const exList = el('exList');
    const wrap = document.createElement('div');
    wrap.className = 'ex-row';
    wrap.innerHTML = `
      <input class="ex-name" placeholder="Exercise name" value="${ex?.exercise||''}">
      <input class="ex-sets" type="number" min="1" step="1" value="${ex?.sets||1}">
      <button class="ex-del" type="button">✕</button>
    `;
    wrap.querySelector('.ex-del').onclick = () => wrap.remove();
    exList.appendChild(wrap);
  }

  function readExerciseRows(){
    const rows = Array.from(document.querySelectorAll('#exList .ex-row'));
    return rows.map(r=>{
      const name = r.querySelector('.ex-name').value.trim();
      const sets = Math.max(1, Number(r.querySelector('.ex-sets').value||1));
      return name ? { exercise: name, sets } : null;
    }).filter(Boolean);
  }

  // ---------------- actions ----------------
  el('addDayBtn').onclick = () => {
    const { prog } = getOrCreateProgram();
    if ((prog.days||[]).length >= MAX_DAYS) { msg("You reached the 6 sessions limit.", "error"); return; }
    openEditor(null);
  };

  el('resetAllBtn').onclick = () => {
    if(!confirm("This clears all your local sessions on this device. Continue?")) return;
    const { list } = getOrCreateProgram();
    const idx = list.findIndex(p=>p.id===PROGRAM_ID);
    if(idx>=0){ list[idx].days = []; savePrograms(list); }
    render();
    msg("Cleared.", "good");
  };

  el('addExBtn').onclick = () => addExerciseRow({exercise:"", sets:2});
  el('cancelEditBtn').onclick = () => { el('editorWrap').classList.add('hidden'); currentEdit = null; };

  el('saveDayBtn').onclick = () => {
    const title = el('dayTitle').value.trim();
    const order = Math.max(0, Number(el('dayOrder').value||0));
    const exercises = readExerciseRows();
    if(!title){ msg("Give the session a title.", "error"); return; }
    if(exercises.length === 0){ msg("Add at least one exercise.", "error"); return; }

    const { list, prog } = getOrCreateProgram();
    prog.days = prog.days || [];

    // enforce limit on create
    const editing = Boolean(currentEdit);
    if(!editing && prog.days.length >= MAX_DAYS){
      msg("Limit reached: 6 sessions per user.", "error"); return;
    }

    // generate a code (stable & short)
    let base = slug(title);
    let code = base;
    const existingCodes = new Set((prog.days||[]).filter(d=>!currentEdit || d.id!==currentEdit.id).map(d=>d.code));
    let n=1; while(existingCodes.has(code)) { code = (base + "_" + (++n)).slice(0,16); }

    if(editing){
      const i = prog.days.findIndex(d=>d.id===currentEdit.id);
      if(i>=0){
        prog.days[i] = {
          ...prog.days[i],
          title, order_index: order,
          // keep old code/id; update code if title changed and causes collision
          code: existingCodes.has(prog.days[i].code) ? code : prog.days[i].code,
          exercises
        };
      }
    }else{
      prog.days.push({
        id: "d_"+uid(),
        code,
        title,
        order_index: order,
        exercises
      });
    }
    // write back
    const pi = list.findIndex(p=>p.id===PROGRAM_ID);
    if(pi>=0) list[pi] = prog; else list.push(prog);
    savePrograms(list);

    el('editorWrap').classList.add('hidden');
    currentEdit = null;
    render();
    msg("Session saved ✅", "good");
  };

  // handle click on list (edit/delete)
  el('daysList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id;
    const { list, prog } = getOrCreateProgram();
    const idx = prog.days.findIndex(d=>d.id===id);
    if(idx<0) return;

    if(btn.dataset.act === 'edit'){
      openEditor(prog.days[idx]);
    }else if(btn.dataset.act === 'delete'){
      if(!confirm("Delete this session?")) return;
      prog.days.splice(idx,1);
      const pi = list.findIndex(p=>p.id===PROGRAM_ID);
      if(pi>=0) list[pi] = prog;
      savePrograms(list);
      render();
      msg("Deleted.", "good");
    }
  });

  // initial render
  render();
  msg("Create up to 6 custom sessions. They’ll appear under “Use my routines (local)” on the Workouts page.", "good");
});
</script>
{% endblock %}