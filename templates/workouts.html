{% extends "base.html" %}
{% block title %}Workouts{% endblock %}

{% block content %}
<style>
  .hidden { display:none }
  .row { display:flex; gap:12px; flex-wrap:wrap }
  .actions { display:flex; gap:8px; flex-wrap:wrap }
  .small { font-size:.9rem; opacity:.75 }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
  .pill { text-decoration:none; padding:6px 10px; border-radius:999px; border:1px solid #e5e5e5 }
  fieldset { margin: 8px 0 14px; border-radius: 10px; padding: 10px 12px }
  label { display:block; margin: 6px 0 4px }
  input, select, button { padding: 8px 10px; border-radius:10px; border:1px solid #ddd }
  .list-item { padding:8px 10px; border:1px solid #eee; border-radius:10px; margin-bottom:8px }
</style>

<div class="topbar">
  <h1>Workout</h1>
  <a href="{{ url_for('home') }}" class="pill">← Dashboard</a>
</div>

<div id="msg" class="small" style="min-height:20px;margin-bottom:8px;"></div>

<!-- Step 1 -->
<fieldset id="stepDay">
  <legend>Choose Day</legend>

  <label for="daySelect">Which day are you on?</label>
  <select id="daySelect" required>
    <option value="" selected disabled>— Select a day —</option>
    <option>Day 1 - Upper A</option>
    <option>Day 2 - Lower A</option>
    <option>Day 4 - Upper B</option>
    <option>Day 5 - Lower B</option>
  </select>

  <label for="notes">Notes (optional)</label>
  <input id="notes" placeholder="How it felt, pains, sleep, etc.">

  <div class="actions" style="margin-top:10px">
    <button id="startBtn" type="button">Start Session</button>
  </div>
  <p class="small">You’ll be asked one exercise at a time.</p>
</fieldset>

<!-- Step 2 -->
<fieldset id="stepExercise" class="hidden">
  <legend id="exTitle">Exercise</legend>

  <div id="set1" class="row">
    <div>
      <label for="set1Reps">Set 1 — Reps</label>
      <input id="set1Reps" type="number" inputmode="numeric" placeholder="e.g., 6–9" min="1" step="1" required>
    </div>
    <div>
      <label for="set1Weight">Set 1 — Weight (kg)</label>
      <input id="set1Weight" type="number" inputmode="decimal" placeholder="kg" min="0" step="0.1" required>
    </div>
  </div>

  <div id="set2" class="row" style="margin-top:8px">
    <div>
      <label for="set2Reps">Set 2 — Reps</label>
      <input id="set2Reps" type="number" inputmode="numeric" placeholder="e.g., 6–9" min="1" step="1">
    </div>
    <div>
      <label for="set2Weight">Set 2 — Weight (kg)</label>
      <input id="set2Weight" type="number" inputmode="decimal" placeholder="kg" min="0" step="0.1">
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <div>
      <label for="rpe">RPE (optional)</label>
      <input id="rpe" type="number" min="1" max="10" inputmode="numeric" placeholder="8" step="1">
    </div>
    <div>
      <label for="exNotes">Notes (optional)</label>
      <input id="exNotes" placeholder="e.g., last reps slow">
    </div>
  </div>

  <div class="actions" style="margin-top:10px">
    <button id="prevBtn" type="button">← Back</button>
    <button id="nextBtn" type="button">Next →</button>
  </div>
  <p class="small" id="progressNote"></p>
</fieldset>

<!-- Step 3 -->
<fieldset id="stepFinish" class="hidden">
  <legend>Finish — Duration & Cardio</legend>

  <label for="duration">How long was your workout? (minutes)</label>
  <input id="duration" type="number" inputmode="numeric" placeholder="e.g., 70" min="1" step="1" required>

  <div style="margin-top:12px">
    <label><input id="didCardio" type="checkbox"> I did cardio</label>
  </div>

  <div id="cardioWrap" class="row hidden" style="margin-top:8px">
    <div>
      <label for="cardioType">Cardio type (optional)</label>
      <input id="cardioType" placeholder="e.g., treadmill, bike">
    </div>
    <div>
      <label for="cardioMin">Cardio duration (min)</label>
      <input id="cardioMin" type="number" inputmode="numeric" placeholder="20" min="1" step="1">
    </div>
  </div>

  <div class="actions" style="margin-top:10px">
    <button id="backToExercises" type="button">← Back</button>
    <button id="toSummary" type="button">Next: Summary →</button>
  </div>
</fieldset>

<!-- Step 4 -->
<fieldset id="stepSummary" class="hidden">
  <legend>Summary</legend>
  <div id="summaryList"></div>
  <div class="actions" style="margin-top:10px">
    <button id="saveServer" type="button">Save to Server (SQLite)</button>
    <button id="exportCsv" type="button">Export CSV</button>
    <button id="exportGoogle" type="button">Export to Google Sheets</button>
  </div>
</fieldset>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---- plans ----
  const DAY_PLANS = {
    "Day 1 - Upper A": [
      {exercise:"Flat chest press", sets:2},
      {exercise:"Shoulder press", sets:2},
      {exercise:"Upper back row", sets:2},
      {exercise:"Lat pulldown", sets:2},
      {exercise:"Tricep push down", sets:2},
      {exercise:"Bicep curl", sets:2}
    ],
    "Day 2 - Lower A": [
      {exercise:"Squat pattern / Leg press", sets:2},
      {exercise:"Seated hammy", sets:2},
      {exercise:"Leg extensions", sets:1},
      {exercise:"Adductors", sets:2},
      {exercise:"Calves", sets:2},
      {exercise:"Abs", sets:2}
    ],
    "Day 4 - Upper B": [
      {exercise:"Upper back row", sets:2},
      {exercise:"Lat biased row", sets:2},
      {exercise:"Incline chest press", sets:2},
      {exercise:"Lateral raise", sets:2},
      {exercise:"Tricep compound (dips, JM)", sets:2},
      {exercise:"Bicep curl", sets:2}
    ],
    "Day 5 - Lower B": [
      {exercise:"Hip hinge (RDL , hyperextensions)", sets:2},
      {exercise:"Squat pattern / Leg press", sets:1},
      {exercise:"Leg extension", sets:1},
      {exercise:"Lying hammy", sets:1},
      {exercise:"Adductors", sets:2},
      {exercise:"Calves", sets:2},
      {exercise:"Abs", sets:2}
    ]
  };

  // ---- helpers/state ----
  const el = id => document.getElementById(id);
  const msg = (t, kind="info") => {
    const m = el("msg"); if(!m) return;
    m.style.color = kind==="error" ? "crimson" : "#111";
    m.textContent = t || "";
  };
  const uid = () => 's-' + Math.random().toString(36).slice(2,10);
  const clampNum = (v,min=0) => {
    const n = Number(v);
    return Number.isFinite(n) ? Math.max(min, n) : 0;
  };
  function todayParts(){
    const d = new Date();
    return {
      ts: d.toISOString().slice(0,19).replace("T"," "),
      date: d.toISOString().slice(0,10),
      day: d.toLocaleDateString(undefined,{ weekday:"long" })
    };
  }
  function volume(sets,reps,kg){ return (clampNum(sets,0))*(clampNum(reps,0))*(clampNum(kg,0)); }

  const state = { sessionId:null, dayName:null, program:"", durationMin:null, notes:"", plan:[], i:0, rows:[] };

  // ensure dropdown populated if needed
  const daySelect = el("daySelect");
  if (daySelect && daySelect.options.length <= 1) {
    Object.keys(DAY_PLANS).forEach(name => {
      const o = document.createElement("option");
      o.value = name; o.textContent = name;
      daySelect.appendChild(o);
    });
  }

  // cardio show/hide
  el("didCardio").addEventListener("change", (e)=>
    el("cardioWrap").classList.toggle("hidden", !e.target.checked)
  );

  // ---- start session ----
  el("startBtn").onclick = () => {
    if (!daySelect.value) { msg("Pick a day first.", "error"); daySelect.focus(); return; }
    state.dayName = daySelect.value;
    state.plan = DAY_PLANS[state.dayName] || [];
    if (state.plan.length === 0) { msg("This day has no plan.", "error"); return; }

    if(state.dayName.includes("Upper")) state.program = state.dayName.includes("A") ? "Upper A" : "Upper B";
    else if(state.dayName.includes("Lower")) state.program = state.dayName.includes("A") ? "Lower A" : "Lower B";
    else state.program = "General";

    state.notes = el("notes").value.trim();
    state.sessionId = uid(); state.i = 0; state.rows = [];
    msg("");
    el("stepDay").classList.add("hidden");
    el("stepExercise").classList.remove("hidden");
    renderExercise();
  };

  // ---- render exercise ----
  function clearSet2Inputs(){ el("set2Reps").value = ""; el("set2Weight").value = ""; }
  function renderExercise(){
    const item = state.plan[state.i]; if(!item){ return showFinishStep(); }
    el("exTitle").textContent = item.exercise;
    el("progressNote").textContent = `Exercise ${state.i+1} of ${state.plan.length} • ${item.sets} set(s)`;
    el("set1Reps").value=""; el("set1Weight").value="";
    clearSet2Inputs(); el("rpe").value=""; el("exNotes").value="";

    if(item.sets >= 2){ el("set2").classList.remove("hidden"); }
    else { el("set2").classList.add("hidden"); clearSet2Inputs(); }
  }

  // ---- next / prev ----
  el("nextBtn").onclick = () => {
    const item = state.plan[state.i]; if(!item) return;

    const s1r = clampNum(el("set1Reps").value, 1);
    const s1w = clampNum(el("set1Weight").value, 0);
    const s2r = clampNum(el("set2Reps").value, 1);
    const s2w = clampNum(el("set2Weight").value, 0);
    const rpe = el("rpe").value ? clampNum(el("rpe").value, 1) : "";
    const exNotes = el("exNotes").value.trim();

    if(!s1r || !s1w){ msg("Fill Set 1 reps and weight.", "error"); return; }
    if((state.plan[state.i].sets >= 2) && (!s2r || !s2w)){ msg("Fill Set 2 reps and weight (or Back).", "error"); return; }

    const { ts, date, day } = todayParts();

    // set 1
    state.rows.push({
      timestamp: ts, date, day_name: day, program: state.program,
      session_id: state.sessionId, exercise: item.exercise, sets: 1,
      reps: s1r, weight_kg: s1w, rpe,
      volume_kg: volume(1,s1r,s1w),
      duration_min: "", notes: state.notes ? `${state.notes} ${exNotes}`.trim() : exNotes, source: "pwa"
    });

    // set 2 if prescribed
    if(item.sets >= 2){
      state.rows.push({
        timestamp: ts, date, day_name: day, program: state.program,
        session_id: state.sessionId, exercise: item.exercise, sets: 2,
        reps: s2r, weight_kg: s2w, rpe,
        volume_kg: volume(1,s2r,s2w),
        duration_min: "", notes: state.notes ? `${state.notes} ${exNotes}`.trim() : exNotes, source: "pwa"
      });
    }

    state.i++; (state.i >= state.plan.length) ? showFinishStep() : renderExercise();
    msg("");
  };

  el("prevBtn").onclick = () => {
    if(state.i === 0){
      el("stepExercise").classList.add("hidden");
      el("stepDay").classList.remove("hidden");
      state.sessionId=null; state.plan=[]; state.rows=[]; state.i=0; state.program=""; msg("");
      return;
    }
    const prevSets = state.plan[state.i-1].sets || 1;
    for(let k=0;k<prevSets;k++){ state.rows.pop(); }
    state.i--; renderExercise();
  };

  // ---- finish & summary ----
  function showFinishStep(){
    el("stepExercise").classList.add("hidden");
    el("stepFinish").classList.remove("hidden");
  }

  el("backToExercises").onclick = () => {
    el("stepFinish").classList.add("hidden");
    el("stepExercise").classList.remove("hidden");
  };

  el("toSummary").onclick = () => {
    const dur = clampNum(el("duration").value, 1);
    if(!dur){ msg("Enter workout duration in minutes.", "error"); return; }
    state.durationMin = dur;

    // apply duration
    state.rows = state.rows.map(r => ({ ...r, duration_min: state.durationMin }));

    // cardio (only one row max)
    const did = el("didCardio").checked;
    if(did){
      const cmin = clampNum(el("cardioMin").value, 1);
      const ctype = (el("cardioType").value || "").trim();
      if(cmin){
        const { ts, date, day } = todayParts();
        // ensure only one cardio row for the session
        state.rows = state.rows.filter(r => !/^Cardio/.test(r.exercise));
        state.rows.push({
          timestamp: ts, date, day_name: day, program: state.program,
          session_id: state.sessionId, exercise: ctype ? `Cardio (${ctype})` : "Cardio",
          sets: 1, reps: cmin, weight_kg: 0, rpe: "",
          volume_kg: 0, duration_min: state.durationMin,
          notes: state.notes, source: "pwa"
        });
      }
    }

    showSummary();
    msg("");
  };

  function showSummary(){
    el("stepFinish").classList.add("hidden");
    el("stepSummary").classList.remove("hidden");
    const box = el("summaryList");
    box.innerHTML = "";
    state.rows.forEach(r=>{
      const setLabel = (r.sets===1 || String(r.exercise).startsWith("Cardio")) ? "" : ("Set " + r.sets + ": ");
      const mainVal = String(r.exercise).startsWith("Cardio")
        ? `${r.reps} min`
        : `${r.reps} reps @ ${Number(r.weight_kg || 0).toFixed(1)}kg`;
      const rpeTxt = r.rpe ? `(RPE ${r.rpe})` : "";
      const meta = `${r.program} • duration ${r.duration_min} min • ${r.date} ${r.day_name} • ${r.session_id}`;

      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML =
        `<b>${r.exercise}</b> — ${setLabel}${mainVal} ${rpeTxt}<br><span class="small">${meta}</span>`;
      box.appendChild(div);
    });
  }

  // ---- save to server ----
  el("saveServer").addEventListener("click", async (e)=>{
    if (state.rows.length === 0) { msg("Nothing to save — complete at least one exercise.", "error"); return; }
    const btn = e.currentTarget;
    btn.disabled = true; btn.textContent = "Saving…";
    try {
      const res = await fetch("/api/logs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rows: state.rows })
      });
      const data = await res.json().catch(()=>({ok:false,error:"Bad JSON"}));
      if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
      msg(`Saved ${data.saved} row(s) to DB ✅`, "info");
    } catch (err) {
      console.error("Save failed:", err);
      msg("Save failed. Check console for details.", "error");
    } finally {
      btn.disabled = false; btn.textContent = "Save to Server (SQLite)";
    }
  });

  // ---- export CSV ----
  function toCSV(rows){
    const header = ["timestamp","date","day_name","program","session_id","exercise","sets","reps","weight_kg","rpe","volume_kg","duration_min","notes","source"];
    const esc = v => { if(v===null||v===undefined) return ""; const s=String(v).replace(/\"/g,'\"\"'); return /[\",\n]/.test(s) ? `"${s}"` : s; };
    const lines = [header.join(",")].concat(rows.map(r=>header.map(h=>esc(r[h])).join(",")));
    return lines.join("\n");
  }
  el("exportCsv").onclick = () => {
    const logs = state.rows.length ? state.rows : [];
    if(logs.length===0){ msg("No data to export.", "error"); return; }
    const blob = new Blob([toCSV(logs)], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "gym_log.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  // ---- export to Google Sheets ----
  el("exportGoogle").addEventListener("click", async () => {
    try {
      const body = (state && Array.isArray(state.rows) && state.rows.length)
        ? { rows: state.rows }   // export current session rows
        : {};                    // or export recent rows from DB

      const res = await fetch("/api/export/google", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
      alert(`Exported ${data.exported} row(s) to Google Sheets ✅`);
    } catch (err) {
      console.error(err);
      alert("Export failed. Check server logs.");
    }
  });

}); // DOMContentLoaded
</script>
{% endblock %}